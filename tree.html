<!DOCTYPE html>
<html>
<head>
  <title>Collapsible Tree Graph</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Add any custom styles here */
  </style>
</head>
<body>
  <div id="chart-container"></div>

  <script>
    const container = document.getElementById('chart-container');
    const width = container.innerWidth;
    const height = container.innerHeight;

    const margin = { top: 20, right: 90, bottom: 30, left: 90 };
    const dx = 10;
    const dy = width / 6;
    const diagonal = d3.linkHorizontal().x(d => d.y).y(d => d.x);

    const tree = d3.tree().nodeSize([dx, dy]);

    d3.csv("data.csv").then(function(data) {
      // Data preprocessing
      const nestedData = d3.group(data, d => d.District);
      const root = {
        name: "Uganda",
        children: Array.from(nestedData, ([district, values]) => ({
          name: district,
          children: Array.from(d3.group(values, d => d.Village), ([village, villageValues]) => ({
            name: village,
            children: villageValues.map(entry => ({
              name: entry.Parameter,
              ecoli: +entry.ecoli
            }))
          }))
        }))
      };

      console.log("Root:", root);

      const svg = d3.select("#chart-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .style("background-color", "#f9f9f9");

      const g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      const rootHierarchy = d3.hierarchy(root);
      const treeData = tree(rootHierarchy);

      const links = treeData.links();
      const nodes = treeData.descendants();

      const link = g.selectAll(".link")
        .data(links)
        .enter()
        .append("path")
        .attr("class", "link")
        .attr("d", d => diagonal(d.data))

      const node = g.selectAll(".node")
        .data(nodes)
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => "translate(" + d.y + "," + d.x + ")");

      node.append("circle")
        .attr("r", 4.5);

      node.append("text")
        .attr("dy", 3)
        .attr("x", d => d.children ? -8 : 8)
        .style("text-anchor", d => d.children ? "end" : "start")
        .text(d => d.data.name);

      console.log("Nodes:", nodes);
      console.log("Links:", links);
    });
  </script>
</body>
</html>
