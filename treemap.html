<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Uganda Water Quality Treemap</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.css" integrity="sha512-lhED0QnU6fy7vF2t1QyxMziFSvJkV6g4c6yM2vBjHOGtw0y6vWuv7Ilo8N9SMh0LlOdk8wvNtC9sXwD9CHeh6g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    #chart {
      margin-top: 20px;
    }

    rect {
      stroke-width: 1px;
    }

    text {
      font-size: 10px;
    }

    .popup {
      position: absolute;
      pointer-events: none;
      background-color: white;
      padding: 5px;
      border: 1px solid gray;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>Uganda Water Quality Treemap</h1>
  <div id="district-select">
    <label for="district">Select District:</label>
    <select id="district">
      <option value="all">All Districts</option>
    </select>
  </div>
  <div id="chart"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js" integrity="sha512-OD7+6pk73K2fVSTe1ukF6F82g2rF84W/tZoCPhAdxUpznGdj06IkTRzCCP3GMB9SQDHD3P7Rz33eQVfIjGOSdg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    const districtSelect = d3.select("#district");

    d3.csv("water_quality.csv").then(function(data) {
      // Get unique districts
      const districts = Array.from(new Set(data.map(d => d.District)));

      // Populate the district select dropdown
      districtSelect
        .selectAll("option")
        .data(districts)
        .enter()
        .append("option")
        .attr("value", function(d) {
          return d;
        })
        .text(function(d) {
          return d;
        });

      // Chart dimensions
      const width = 1000;
      const height = 800;

      // Create a D3.js treemap layout
      const treemap = d3.treemap()
        .size([width, height])
        .padding(1);

      // Function to update the treemap based on the selected district
      function updateTreemap(selectedDistrict) {
        // Filter the data based on the selected district
        const filteredData = selectedDistrict === "all" ? data : data.filter(d => d.District === selectedDistrict);

        const root = {
          name: "Uganda",
          children: Array.from(new Set(filteredData.map(d => d.Parameter))).map(parameter => {
            return {
              name: parameter,
              children: filteredData
                .filter(d => d.Parameter === parameter)
                .map(d => ({
                  name: d.District,
                  value: +d.Value
                }))
            };
          })
        };

        const treemapData = d3.hierarchy(root)
          .sum(d => d.value)
          .sort((a, b) => b.value - a.value);

        // Generate the treemap layout
        treemap(treemapData);

        // Remove previous chart elements
        d3.select("#chart")
          .selectAll("g")
          .remove();

        // Create the chart SVG and groups
        const svg = d3.select("#chart")
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .style("font-size", "10px");

        const chartGroup = svg.append("g")
          .attr("transform", "translate(0, 20)");

        const node = chartGroup.selectAll("g")
          .data(treemapData.descendants())
          .enter()
          .append("g")
          .attr("transform", function(d) {
            return "translate(" + d.x0 + "," + d.y0 + ")";
          });

        // Create rectangles for each node
        node.append("rect")
          .attr("width", function(d) {
            return d.x1 - d.x0;
          })
          .attr("height", function(d) {
            return d.y1 - d.y0;
          })
          .attr("fill", function(d) {
            const districtName = d.data.name;
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            return colorScale(districtName);
          })
          .attr("stroke", "white")
          .on("mouseover", function(d) {
            const popup = d3.select("#chart")
              .append("div")
              .attr("class", "popup")
              .style("left", d3.event.pageX + "px")
              .style("top", d3.event.pageY + "px")
              .text(d.data.name + ": " + d.value);
          })
          .on("mouseout", function() {
            d3.select(".popup").remove();
          });

        node.append("text")
          .attr("clip-path", function(d, i) { return "url(#clip-" + i + ")"; })
          .selectAll("tspan")
          .data(function(d) {
            return (d.data.name || "").split(/(?=[A-Z][^A-Z])/g);
          })
          .join("tspan")
          .attr("x", 4)
          .attr("y", function(d, i) {
            return 13 + i * 10;
          })
          .text(function(d) {
            return d;
          });

        node.append("title")
          .text(function(d) {
            return d.data.name + "\nValue: " + d.value;
          });
      }

      // Function to handle the select change event
      function handleSelectChange() {
        const selectedDistrict = districtSelect.property("value");
        updateTreemap(selectedDistrict);
      }

      // Event listener for select change event
      districtSelect.on("change", handleSelectChange);

      // Initialize the treemap with all districts
      updateTreemap("all");
    });
  </script>
</body>
</html>
